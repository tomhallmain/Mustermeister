<div class="container mx-auto px-2 py-4">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-xl font-bold text-gray-900">Kanban Board</h1>
    
    <div class="flex items-center space-x-4">
      <select id="project-filter" class="rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
        <option value="">All Projects</option>
        <% @projects.each do |project| %>
          <option value="<%= project.id %>" <%= 'selected' if @current_project&.id == project.id %>><%= project.title %></option>
        <% end %>
      </select>

      <select id="sort-by" class="rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
        <option value="updated_at" <%= 'selected' if @sort_by == 'updated_at' %>>Last Updated</option>
        <option value="created_at" <%= 'selected' if @sort_by == 'created_at' %>>Created Date</option>
        <option value="priority" <%= 'selected' if @sort_by == 'priority' %>>Priority</option>
      </select>
    </div>

    <div class="flex items-center space-x-2">
      <label for="show-all-completed" class="text-sm text-gray-700">Show all completed tasks</label>
      <div class="relative inline-block w-10 mr-2 align-middle select-none">
        <input type="checkbox" id="show-all-completed" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
        <label for="show-all-completed" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
      </div>
    </div>
  </div>

  <div id="kanban-board" class="flex space-x-2 overflow-x-auto pb-4">
    <% {
      not_started: 'Not Started',
      investigations: 'Investigations',
      in_progress: 'In Progress',
      ready_to_test: 'Ready to Test',
      complete: 'Complete'
    }.each do |key, name| %>
      <div class="kanban-column flex-shrink-0 w-64 bg-gray-100 rounded-lg p-2" data-status="<%= key %>">
        <h3 class="text-sm font-semibold text-gray-900 mb-2"><%= name %></h3>
        <div class="kanban-tasks space-y-2 min-h-[200px]" data-status="<%= key %>">
          <!-- Tasks will be loaded here via JavaScript -->
        </div>
      </div>
    <% end %>
  </div>
</div>

<%= javascript_tag do %>
  document.addEventListener('DOMContentLoaded', function() {
    const board = document.getElementById('kanban-board');
    const projectFilter = document.getElementById('project-filter');
    const sortBy = document.getElementById('sort-by');
    const showAllCompleted = document.getElementById('show-all-completed');
    let currentPage = 1;
    let isLoading = false;

    // Initialize Sortable for each column
    document.querySelectorAll('.kanban-tasks').forEach(function(column) {
      new Sortable(column, {
        group: 'tasks',
        animation: 150,
        ghostClass: 'bg-gray-200',
        onEnd: function(evt) {
          const taskId = evt.item.dataset.taskId;
          const newStatus = evt.to.dataset.status;
          updateTaskStatus(taskId, newStatus);
        }
      });
    });

    // Load tasks for all columns
    function loadTasks() {
      if (isLoading) return;
      isLoading = true;

      const params = new URLSearchParams({
        page: currentPage,
        sort_by: sortBy.value,
        show_all_completed: showAllCompleted.checked
      });

      if (projectFilter.value) {
        params.append('project_id', projectFilter.value);
      }

      fetch(`/kanban/tasks?${params}`)
        .then(response => response.json())
        .then(data => {
          // Map backend statuses to display columns
          const statusMapping = {
            not_started: ['not_started'],
            investigations: ['to_investigate', 'investigated_not_started'],
            in_progress: ['in_progress'],
            ready_to_test: ['ready_to_test'],
            complete: ['complete', 'closed']
          };

          // Update each column with its tasks
          Object.entries(statusMapping).forEach(([displayStatus, backendStatuses]) => {
            const column = document.querySelector(`.kanban-tasks[data-status="${displayStatus}"]`);
            if (column) {
              // Combine tasks from all relevant backend statuses
              const tasks = backendStatuses.flatMap(status => data.tasks[status] || []);
              column.innerHTML = tasks.map(task => createTaskCard(task)).join('');
            }
          });
          isLoading = false;
        })
        .catch(error => {
          console.error('Error loading tasks:', error);
          isLoading = false;
        });
    }

    // Create task card HTML
    function createTaskCard(task) {
      return `
        <div class="bg-white rounded-lg shadow p-2 cursor-move" data-task-id="${task.id}">
          <div class="flex justify-between items-start mb-1">
            <h4 class="font-medium text-sm text-gray-900">
              <a href="/tasks/${task.id}" class="hover:text-blue-600 hover:underline">${task.title}</a>
            </h4>
            <span class="px-1.5 py-0.5 text-xs rounded-full
              ${task.priority === 'high' ? 'bg-red-100 text-red-800' :
                task.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                'bg-green-100 text-green-800'}">
              ${task.priority}
            </span>
          </div>
          <p class="text-xs text-gray-600 mb-1">${task.description || ''}</p>
          <div class="flex justify-between items-center text-xs text-gray-500">
            <span>${task.project}</span>
            <span>${new Date(task.updated_at).toLocaleDateString()}</span>
          </div>
        </div>
      `;
    }

    // Update task status
    function updateTaskStatus(taskId, newStatus) {
      fetch(`/tasks/${taskId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
          task: {
            status_id: document.querySelector(`.kanban-column[data-status="${newStatus}"]`).dataset.statusId
          }
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to update task status');
        }
        loadTasks(); // Reload tasks to ensure correct order
      })
      .catch(error => {
        console.error('Error updating task status:', error);
        loadTasks(); // Reload tasks to reset the board
      });
    }

    // Add event listeners for filters
    projectFilter.addEventListener('change', loadTasks);
    sortBy.addEventListener('change', loadTasks);
    showAllCompleted.addEventListener('change', loadTasks);

    // Initial load
    loadTasks();
  });
<% end %>

<style>
  .toggle-checkbox:checked {
    right: 0;
    border-color: #68D391;
  }
  .toggle-checkbox:checked + .toggle-label {
    background-color: #68D391;
  }
</style> 